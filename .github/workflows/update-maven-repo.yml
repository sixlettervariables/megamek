#
# 
#
name: Update Maven Repo

on:
  push:
    branches: [ test-push ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        path: megamek
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Grant execute permission for gradlew
      working-directory: megamek
      run: chmod +x gradlew
    - name: Publish Maven Repo with Gradle
      working-directory: megamek
      run: ./gradlew publishPublishMMLibraryPublicationToMavenRepository
    - name: Checkout Maven Repo
      uses: actions/checkout@v2
      with:
        repository: sixlettervariables/mavenrepo
        path: mavenrepo
    - name: Copy Maven Outputs to Repo
      run: |
        cp -r megamek/megamek/build/mavenrepo/ mavenrepo/
    - name: Inspect git status output
      working-directory: mavenrepo
      run: |
        git status
    - name: Commit changes to the Maven Repo
      working-directory: mavenrepo
      run: |
        git add .
        git config user.email ${{ github.event.pusher.email }}
        git config user.name ${{ github.event.pusher.name }}
        git commit -m "MegaMek ${{ github.event.after }}"
    - name: Setup SSH and Push changes to the Maven Repo
      working-directory: mavenrepo
      run: |
        eval "$(ssh-agent -s)"
        ssh-add - <<< "${{ secrets.MAVEN_REPO_DEPLOY_KEY }}"
        git push "git@github.com:sixlettervariables/mavenrepo.git" HEAD:master
